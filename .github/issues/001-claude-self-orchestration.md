# Claude セルフオーケストレーションによるプレイヤー独立性の実現

**Status**: 提案
**Priority**: High
**Created**: 2026-01-25

---

## 背景

v1 では「1つのモデルにGM+複数PLを操作させる設計」で、各プレイヤーの独立した思考が実現できなかった。
v2 では役割別エージェント化を目指しているが、当初想定していた Gemini/Codex によるオーケストレーションでは以下の課題がある：

### Gemini/Codex オーケストレーションの課題

- ゲームマスター（Gemini/Codex）が全プレイヤーの情報を把握している
- 各 Claude プレイヤーは「独立した思考」をしているように見えるが、実際はオーケストレーターの手のひらの上
- ゲームマスターが結果を知っている状態での「演技」になってしまう
- 本質的なプレイヤー独立性が担保されない

---

## 提案: Claude セルフオーケストレーション

Claude が Claude をオーケストレーションすることで、真の独立性を実現する。

### アーキテクチャ

```
Claude GM (ゲームマスター)
  ├─ Claude Player 1 (独立プロセス、独立コンテキスト、役職: 村人)
  ├─ Claude Player 2 (独立プロセス、独立コンテキスト、役職: 人狼)
  └─ Claude Player 3 (独立プロセス、独立コンテキスト、役職: 占い師)
```

### 利点

1. **真の独立性**: 各プレイヤーは本当に独立したコンテキストで思考
2. **情報の隔離**: GM は「公開情報」のみを管理、各プレイヤーの内心は知らない
3. **制限の実現**: プレイヤー間のコミュニケーションは GM 経由で「本当に制限される」
4. **思考の真正性**: 限られた情報での推理・判断が自然に実現される

### 情報管理の例

| 情報カテゴリ | GM | プレイヤーA | プレイヤーB |
|------------|----|-----------|-----------|
| 公開発言 | ✅ | ✅ | ✅ |
| 役職情報 | ✅（全員分） | ✅（自分のみ） | ✅（自分のみ） |
| 夜のアクション | ✅ | ✅（自分のみ） | ❌ |
| 他プレイヤーの思考 | ❌ | ❌ | ❌ |

**重要**: GM も「各プレイヤーがどう考えているか」は知らない。
プレイヤーの思考履歴は各プロセス内にのみ存在。

---

## 実装案

### ディレクトリ構造

```
ai-werewolf/
├── src/
│   ├── game_master.py       # Claude GM（Claude API 経由で各プレイヤーを起動）
│   ├── player_agent.py      # プレイヤーエージェント（独立実行可能）
│   ├── orchestrator.py      # メインループ・セッション管理
│   └── shared/
│       ├── message_queue.py # プレイヤー間通信（GM経由）
│       └── game_state.py    # 公開情報のみ
├── configs/
│   ├── gm_system_prompt.md      # GM 用システムプロンプト
│   └── player_base_prompt.md    # プレイヤー共通プロンプト
└── logs/
    └── games/YYYY-MM-DD-NNN/
        ├── gm.jsonl         # GM の思考ログ
        ├── player1.jsonl    # P1 の独立ログ
        └── public_log.md    # 全員が見える情報
```

### 技術スタック

- **Claude API**: 各プレイヤーを独立した API セッションとして起動
- **メッセージキュー**: GM ⇔ プレイヤー間の通信管理
- **ログ分離**: 各プレイヤーの思考履歴を独立したファイルに記録

---

## 実装ステップ（案）

### Phase 1: 最小実装（2プレイヤー）

- [ ] GM + 村人1人 + 人狼1人
- [ ] 1ターンだけ動かす
- [ ] 情報隔離の検証

### Phase 2: 情報管理の検証

- [ ] 各プレイヤーの会話履歴に他プレイヤーの情報が漏れていないか確認
- [ ] GM が各プレイヤーの思考を知らない状態でゲームが成立するか検証

### Phase 3: ログ設計

- [ ] デバッグ用に各プレイヤーの思考過程を記録
- [ ] 観戦者向けの公開ログ生成

### Phase 4: フルゲーム実装

- [ ] 5プレイヤー以上でのゲーム実行
- [ ] 複数ターンの動作検証

---

## 参考: 技術的な実現可能性

Claude による Claude のオーケストレーションは技術的に可能。
以下の方法で実装できる：

1. **Claude API 直接呼び出し**: 各プレイヤーを独立した API セッションとして起動
2. **プロセス分離**: 各プレイヤーのコンテキストを完全に独立させる
3. **メッセージキュー経由の通信**: GM を介した情報伝達のみ許可

### 最小実装例（コンセプト）

```python
#!/usr/bin/env python3
# orchestrator.py の最小実装イメージ

import anthropic
import os

client = anthropic.Anthropic(api_key=os.environ["ANTHROPIC_API_KEY"])

class Player:
    def __init__(self, player_id, role):
        self.player_id = player_id
        self.role = role
        self.memory = []  # このプレイヤーだけが知っている情報

    def think_and_act(self, public_context):
        """独立したコンテキストで思考・発言"""
        prompt = f"""
あなたはプレイヤー{self.player_id}です。
役職: {self.role}

【あなたが知っている情報】
{self._format_memory()}

【現在の状況】
{public_context}

【あなたの行動】
次に何をしますか？
"""
        response = client.messages.create(
            model="claude-sonnet-4-5",
            max_tokens=2048,
            messages=[{"role": "user", "content": prompt}]
        )
        return response.content[0].text

# GM は公開情報のみを管理
# 各プレイヤーの内心は知らない
```

---

## 関連

- v1 の課題: 単一モデルでの限界
- ADR-006: リポジトリエージェントパターン
- Claude Code エージェント SDK

---

## 次のアクション

このアーキテクチャで進める方向性が合意できたら、Phase 1 の最小実装に着手する。

---

## コメント・議論

（ここに議論を記録）
